<!DOCTYPE html>
<html><head>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>テスト</title>
	<style type="text/css">
		body { margin: 20px; background-color: green; }
	</style>
</head><body>
	<div id="root">
		<div>
			<button id="testButtonReady">ready</button>
			<select id="testSelectDevice">
				<option value="none">未選択</option>
				<option value="user">user</option>
				<option value="environment">environment</option>
			</select>
			<button id="testButtonStart">start</button>
			<select id="testSelectAspect">
				<option value="none">未選択</option>
			</select>
		</div>
		<div><video id="testVideo" width="256" height="256" autoplay muted playsinline></video></div>
	</div>
	<script type="text/javascript">
// ----------------------------------------------------------------
// ----------------------------------------------------------------
// ----------------------------------------------------------------

// 処理はここから始まる
document.addEventListener('DOMContentLoaded', (event) => {
	const testButtonReady = document.getElementById('testButtonReady');
	const testButtonStart = document.getElementById('testButtonStart');
	const testSelectDevice = document.getElementById('testSelectDevice');
	const testSelectAspect = document.getElementById('testSelectAspect');
	const testVideo = document.getElementById('testVideo');
	let track = null;

	Promise.resolve().then(() => {
		// 使わないボタンの無効化
		testButtonStart.disabled = true;
		testSelectDevice.disabled = true;
		testSelectAspect.disabled = true;
	}).then(() => new Promise((resolve, reject) => {
		// クリック待ち
		testButtonReady.addEventListener('click', resolve);
	})).then(() => {
		// 使わなくなったボタンの無効化
		testButtonReady.disabled = true;
	}).then(() => {
		// 権限取得のためのデバイス開始
		const constraints = {};
		constraints.video = true;
		constraints.audio = false;
		return navigator.mediaDevices.getUserMedia(constraints);
	}).then((stream) => {
		// 権限取得によりデバイス停止
		stream.getTracks().forEach((track) => track.stop());
	}).then(() => {
		// デバイス一覧の取得
		return navigator.mediaDevices.enumerateDevices();
	}).then((devices) => {
		// デバイス一覧からセレクトボックスの作成
		for (let i = 0; i < devices.length; i++) {
			if (devices[i].kind !== 'videoinput') { continue; }
			testSelectDevice.appendChild((() => {
				const element = document.createElement('option');
				element.value = JSON.stringify(devices[i]);
				element.innerHTML = devices[i].label;
				return element;
			})());
		}
	}).then(() => {
		// アスペクト比一覧のセレクトボックスの作成
		const aspects = ['9:24', '9:22', '9:20', '9:18', '9:16', '3:4', '1:1', '4:3', '16:9', '18:9', '20:9', '22:9', '24:9',];
		for (let i = 0; i < aspects.length; i++) {
			testSelectAspect.appendChild((() => {
				const element = document.createElement('option');
				element.value = aspects[i];
				element.innerHTML = aspects[i];
				return element;
			})());
		}
	}).then(() => {
		// これから使うボタンの有効化
		testButtonStart.disabled = false;
		testSelectDevice.disabled = false;
		testSelectAspect.disabled = false;
	}).then(() => new Promise((resolve, reject) => {
		// 選択とクリック待ち
		testButtonStart.addEventListener('click', resolve);
	})).then(() => {
		// 使わなくなったボタンの無効化
		testButtonStart.disabled = true;
		testSelectDevice.disabled = true;
		testSelectAspect.disabled = true;
	}).then(() => {
		// 撮影のためのデバイス開始
		const constraints = {};
		constraints.audio = false;

		// カメラデバイス選択
		if (testSelectDevice.value === 'none') {
			constraints.video = {};
		} else if (testSelectDevice.value === 'user') {
			constraints.video = { facingMode: 'user', };
		} else if (testSelectDevice.value === 'environment') {
			constraints.video = { facingMode: 'environment', };
		} else {
			const device = JSON.parse(testSelectDevice.value);
			constraints.video = { deviceId: { exact: device.deviceId, }, };
		}

		// アスペクト比選択
		if (testSelectAspect.value !== 'none') {
			const value = testSelectAspect.value.split(':');
			const aspect = Number(value[0]) / Number(value[1]);
			constraints.video.aspectRatio = aspect;
		}

		return navigator.mediaDevices.getUserMedia(constraints);
	}).then((stream) => new Promise((resolve, reject) => {
		// デバイス開始により取得したストリームの処理
		track = stream.getVideoTracks()[0];
		testVideo.addEventListener('loadedmetadata', resolve);
		testVideo.srcObject = stream;
	})).then(() => {
		// アスペクト比選択
		testSelectAspect.disabled = false;
		testSelectAspect.addEventListener('change', () => {
			testSelectAspect.disabled = true;
			const value = testSelectAspect.value.split(':');
			const aspect = Number(value[0]) / Number(value[1]);
			const constraints = {};
			constraints.aspectRatio = aspect;
			track.applyConstraints(constraints).then(() => {
				testSelectAspect.disabled = false;
			});
		});
	});;
});

// ----------------------------------------------------------------
// ----------------------------------------------------------------
// ----------------------------------------------------------------
	</script>
</body></html>
